<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gráfico tipo Excel</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table, th, td {
      border: 1px solid #ccc;
      border-collapse: collapse;
      padding: 5px;
      text-align: center;
    }
    input[type="color"] { width: 40px; }
    .btn { margin: 5px; }
  </style>
</head>
<body>
  <h2>Mini Excel Web - Gráfico Personalizable</h2>

  <label>Tipo de gráfico:</label>
  <select id="tipoGrafico">
    <option value="bar">Barras</option>
    <option value="line">Líneas</option>
    <option value="pie">Pastel</option>
  </select>
  <button class="btn" onclick="agregarColumna()">+ Columna</button>
  <button class="btn" onclick="agregarFila()">+ Fila</button>

  <table id="tabla">
    <thead>
      <tr>
        <th>Etiqueta</th>
        <th>
          Serie 1 <br><input type="color" value="#3498db">
        </th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td contenteditable>Lunes</td>
        <td contenteditable>10</td>
      </tr>
      <tr>
        <td contenteditable>Martes</td>
        <td contenteditable>20</td>
      </tr>
    </tbody>
  </table>

  <button class="btn" onclick="actualizarGrafico()">Actualizar Gráfico</button>

  <canvas id="grafico" width="600" height="300"></canvas>

  <br>
  <button onclick="guardarImagen()">Guardar como PNG</button>
  <button onclick="exportarCSV()">Exportar datos CSV</button>

  <script>
    let chart;

    function agregarColumna() {
      const tabla = document.getElementById('tabla');
      const headRow = tabla.rows[0];
      const numCols = headRow.cells.length;
      const color = getRandomColor();

      const th = document.createElement('th');
      th.innerHTML = `Serie ${numCols}<br><input type="color" value="${color}">`;
      headRow.appendChild(th);

      for (let i = 1; i < tabla.rows.length; i++) {
        const td = document.createElement('td');
        td.contentEditable = true;
        td.textContent = "0";
        tabla.rows[i].appendChild(td);
      }
    }

    function agregarFila() {
      const tabla = document.getElementById('tabla');
      const row = document.createElement('tr');
      const numCols = tabla.rows[0].cells.length;

      for (let i = 0; i < numCols; i++) {
        const td = document.createElement('td');
        td.contentEditable = true;
        td.textContent = i === 0 ? "Nueva etiqueta" : "0";
        row.appendChild(td);
      }
      tabla.querySelector('tbody').appendChild(row);
    }

    function getRandomColor() {
      return '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
    }

    function actualizarGrafico() {
      const tabla = document.getElementById('tabla');
      const etiquetas = [];
      const datasets = [];
      const numCols = tabla.rows[0].cells.length;

      for (let j = 1; j < numCols; j++) {
        const header = tabla.rows[0].cells[j];
        const color = header.querySelector('input').value || getRandomColor();
        datasets.push({
          label: `Serie ${j}`,
          data: [],
          backgroundColor: color,
          borderColor: color,
          borderWidth: 2
        });
      }

      for (let i = 1; i < tabla.rows.length; i++) {
        const row = tabla.rows[i];
        etiquetas.push(row.cells[0].innerText.trim());
        for (let j = 1; j < numCols; j++) {
          const valor = parseFloat(row.cells[j].innerText.trim()) || 0;
          datasets[j - 1].data.push(valor);
        }
      }

      const tipo = document.getElementById('tipoGrafico').value;
      const ctx = document.getElementById('grafico').getContext('2d');
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: tipo,
        data: {
          labels: etiquetas,
          datasets: datasets
        },
        options: {
          responsive: true,
          scales: tipo !== 'pie' ? { y: { beginAtZero: true } } : {}
        }
      });
    }

    function guardarImagen() {
      const link = document.createElement('a');
      link.download = 'grafico.png';
      link.href = document.getElementById('grafico').toDataURL('image/png');
      link.click();
    }

    function exportarCSV() {
      const tabla = document.getElementById('tabla');
      let csv = [];
      for (let i = 0; i < tabla.rows.length; i++) {
        let fila = [];
        for (let j = 0; j < tabla.rows[i].cells.length; j++) {
          let texto = tabla.rows[i].cells[j].innerText;
          fila.push(`"${texto}"`);
        }
        csv.push(fila.join(","));
      }

      const blob = new Blob([csv.join("\n")], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "datos.csv";
      a.click();
    }

    actualizarGrafico();
  </script>
</body>
</html>
